
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confirm Your Order</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
  
  <style>
    body {
      background-color: #f0f2f5; /* Light background for the whole page */
    }
    
    h1 {
      color: #343a40; /* Darker heading color */
    }
    
    form {
      background-color: #ffffff; /* White background for the form */
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    
    form h3 {
      color: #495057; /* Slightly muted heading color */
      margin-bottom: 1.5rem;
    }
    
    select, .list-group-item {
      background-color: #f8f9fa;
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
    }
    
    .list-group-item {
      padding: 1.5rem;
    }
    
    .list-group-item strong {
      font-size: 1.1rem;
      color: #212529; /* Darker text color for emphasis */
    }
    
    button[type="submit"] {
      background-color: #d35400;;
      color: white;
      padding: 0.75rem 2rem;
      font-size: 1.2rem;
      border-radius: 5px;
      border: none;
      transition: background-color 0.3s;
    }
    
    button[type="submit"]:hover {
      background-color:#eb9d6a;
    }
    
    .form-select {
      padding: 0.75rem;
      font-size: 1rem;
    }
  </style>
</head>
<body>

  <%- include("../../views/partials/user/headerNew") %>

  <div class="container mt-5" style="background-color: #00131c; margin-bottom: 50px; padding-bottom: 30PX;">
    <h3 class="text-center mb-5" style="color: white;">Confirm Your Order</h3>
    <div class="row justify-content-center" ">
      <div class="col-lg-8" >
        
          <form id="orderForm" action="/order/place" method="POST" class="p-4 border rounded shadow">
          <!-- Address Selection -->
          <div class="mb-4">
            <h4>Select Delivery Address</h4>
            <select name="selectedAddress" class="form-select">
              <% addressData.forEach(address => { %>
                <option value="<%= address._id %>">
                  <%= address.name %>, <%= address.city %>, <%= address.state %> - <%= address.pincode %>
                </option>
              <% }) %>
            </select>
          </div>

          <!-- Payment Method Selection -->
          <!-- <div class="mb-4">
            <h4>Select Payment Method</h4>
            <select name="paymentMethod" class="form-select">
              <option value="Cash on Delivery" selected>Cash on Delivery</option>
               <option value="Credit Card">Credit Card</option>
              <option value="PayPal">Online payment</option> 
            </select>
          </div>
              -->

              <div class="mb-4">
                <h4>Select Payment Method</h4>
                <select name="paymentMethod" id="paymentMethod" class="form-select">
                  <option value="Cash on Delivery" selected>Cash on Delivery</option>
                  <option value="Online payment">Online payment</option>
                </select>
              </div>

          <div class="mb-4">
            <h4>Select Coupon</h4>
            <select name="coupon" id="couponSelect" class="form-select">
              <option value="" data-discount="0">No Coupon</option>
              <% couponData.forEach(coupon =>{ %>
                <option value="<%= coupon._id%>" data-discount="<%= coupon.discountValue%>">
                  <%= coupon.description %> - Discount: <%= coupon.discountValue %>
      </option>
                <% }) %>
            </select>

          </div>

          
          <!-- Cart Items -->
          <div class="mb-4">
            <h4>Your Cart Items</h4>
            <ul class="list-group">
              <% cartItems.forEach(item => { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong><%= item.productId.productName %></strong>
                    <div>Quantity: <%= item.quantity %></div>
                  </div>
                  <span>Total: &#8377; <%= item.totalPrice %> </span>
                </li>
                
              <% }) %>
              
            </ul>
            
            <p style="text-align: right;">Original Total: &#8377; <%= totalOrderPrice.toFixed(2) %></p>
            <p style="text-align: right;" id="discountAmount">Discount: &#8377; 0.00</p>
            <p style="text-align: right;" id="finalTotalPrice">Final Price: &#8377; <%= totalOrderPrice.toFixed(2) %></p>
          </div>

          
<div class="text-center">
  <button type="submit" id="placeOrderBtn" class="btn btn-success btn-lg px-5" style="border: none; background-color: #d35400;">Place Order</button>
  <button type="button" class="btn btn-success btn-lg px-5" style="background-color: #d35400; border: none; height: 51px;">
    <a href="/cart" style="color: white; text-decoration: none;">Back to cart</a>
  </button>
         </div>

        </form>
      </div>
    </div>
  </div>

  <%- include("../../views/partials/user/footer") %>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>



document.addEventListener("DOMContentLoaded", function () {
    const orderId = '<%= orderId %>'; 

    fetch(`/razorpay/create-order/${orderId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        
      }),
    }).then(response => response.json())
      .then(data => {
        
      })
      .catch(error => console.error('Error:', error));
  });

document.getElementById('couponSelect').addEventListener('change',function(){
  const couponSelect = document.getElementById('couponSelect');
    if (couponSelect.value === "") {
        couponSelect.disabled = true; 
    }
  const selectedOption = this.options[this.selectedIndex];
  const discountValue = parseFloat(selectedOption.getAttribute('data-discount')) || 0
  const originalPrice = parseFloat('<%= totalOrderPrice.toFixed(2) %>');

  const finalPrice = originalPrice - discountValue;
  document.getElementById('discountAmount').innerText = 'Discount: ₹' + discountValue.toFixed(2);
    document.getElementById('finalTotalPrice').innerText = 'Final Price: ₹' + finalPrice.toFixed(2);
 
})



    document.getElementById('placeOrderBtn').addEventListener('click', function() {
      Swal.fire({
        title: 'Confirm Order',
        text: "Are you sure you want to place this order?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, place it!'
      }).then((result) => {
        if (result.isConfirmed) {
          
          document.getElementById('orderForm').submit();
        }
      })
    });



    document.getElementById('placeOrderBtn').addEventListener('click', function () {
    
        placeOrder();
      });

      function placeOrder() {
        
        fetch("/razorpay/create-order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            
            amount: 2999, 
            userId: '<%= user._id %>' 
          }),
        })
        .then(response => response.json()) 
        .then(data => {
          if (data.orderId) {
          
            Swal.fire({
              title: 'Order Placed!',
              text: `Your order has been placed successfully. Order ID: ${data.orderId}`,
              icon: 'success',
              confirmButtonText: 'OK'
            }).then(() => {
              
              window.location.href = '/order/success';
            });
          } else {
            
            Swal.fire({
              title: 'Error',
              text: 'There was a problem placing your order. Please try again.',
              icon: 'error',
              confirmButtonText: 'OK'
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          Swal.fire({
            title: 'Error',
            text: 'There was a problem placing your order. Please try again later.',
            icon: 'error',
            confirmButtonText: 'OK'
          });
        });
      }
  document.addEventListener("DOMContentLoaded", function () {
    const orderId = "67120d4e2c1d2cfab61d8dd7"; 
    
    fetch(`/razorpay/create-order/${orderId}`, {
      method: "POST",
      headers: {
        'Content-Type': 'application/json'
      },
    })
    .then(response => response.json())
    .then(data => {
      console.log("Razorpay order created:", data);
      
    })
    .catch(error => {
      console.error('Error:', error);
    });
  });
  </script>
  
</body>
</html>

